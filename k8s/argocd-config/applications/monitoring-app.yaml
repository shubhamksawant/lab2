apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: humor-game-monitoring
  namespace: argocd
spec:
  project: humor-game-project
  source:
    repoURL: https://github.com/shubhamksawant/lab2.git
    targetRevision: main 
    path: k8s/monitoring # Points to your folder with monitoring.yaml, rbac, etc.
    directory:
      recurse: true # Ensures it picks up the JSON dashboard files if they are referenced
  
  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring # Matches the namespace in your monitoring.yaml

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
    - ApplyOutOfSyncOnly=true
    # Monitoring involves RBAC; this ensures it applies correctly
    - SkipDryRunOnMissingResource=true 

  ignoreDifferences:
  - group: ''
    kind: ConfigMap
    name: grafana-dashboards # Ignores differences in large JSON dashboard strings
    jsonPointers:
    - /data
  - group: ''
    kind: PersistentVolumeClaim
    jsonPointers:
    - /spec/volumeName # Allows K8s to assign the volume without ArgoCD fighting it

  revisionHistoryLimit: 5